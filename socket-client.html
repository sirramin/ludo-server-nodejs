<!doctype html>
<html>
<head>
    <title>Arta platfrom socket client</title>
</head>
<body>
<h1><span>you are player: </span><span id="playerNumber"></span></h1>
<ul id="messages"></ul>
<button id="connect">connect</button>
<button id="joinRoom">joinRoom</button>
<button id="rollDice">rollDice</button>
<select id="move">
    <option value="">--</option>
</select>
<button id="leftRoom">leftRoom</button>
<button id="profile">profile</button>
<!--<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
    // const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYlVybCI6Im1lbmNobWFuIiwidXNlcklkIjoiNWI0MWZkZGY0YTBjYzg2YjQzMDMwODExIiwibmFtZSI6InVzZXI1ODYxNSIsIm1hcmtldCI6Im1jaSIsInVzZXJuYW1lIjoic2lycmFtaW41IiwiaWF0IjoxNTMxMDUxNDg3LCJleHAiOjE1MzE5MTU0ODd9.j9BamCitP6RiOCjJ-5ppvI-Kpqq4EMHRnAlBEFfrzV0"
    $(function () {
        // const target = 'http://platform.artagamestudio.com'
        const target = 'http://localhost:3000'
        let token
        $('#connect').click(async () => {
            if (!localStorage.token) {
                const res = await $.ajax({
                    url: target + "/user/signInAsGuest",
                    type: 'post',
                    data: {
                        market: 'cafeBazaar'
                    },
                    headers: {
                        gameid: '5b39d163afff3d2cf7833f6e', //menchman game
                    },
                    dataType: 'json',
                })
                localStorage.setItem("token", res.data.token)
                token = res.data.token
            }
            else {
                token = localStorage.token
                const res = await $.ajax({
                    url: target + "/logics/menchman/getUserGameData",
                    type: 'get',
                    headers: {
                        token: localStorage.token
                    },
                    dataType: 'json',
                })

                if (!localStorage.userId)
                    localStorage.setItem("userId", res.data.userId)
                localStorage.setItem("UserGameData", JSON.stringify(res.data))
            }
            const socket = io(target, {transports: ['websocket'], query: {token: token}})
            $('#joinRoom').click(() => {
                socket.emit('joinRoom', 1)
            })

            $('#leftRoom').click(() => {
                socket.emit('leftRoom', 1)
            })

            $('#profile').click(() => {
                socket.emit('event', JSON.stringify({
                    act: 'profile'
                }))
            })

            $('#rollDice').on('click', () => {
                $('#move').html('<option value="">--</option>')
                socket.emit('event', JSON.stringify({
                    act: 'rollDice',
                    data: {}
                }))
            })

            $('select').on('change', function () {
                if (this.value)
                    socket.emit('event', JSON.stringify({
                        act: 'move',
                        data: {
                            marbleNumber: this.value
                        }
                    }))
            })

            socket.on('message', function (msg) {
                $('#messages').append($('<li>').text(JSON.stringify(msg)))
            })

            socket.on('matchEvent', function (data) {
                $('#messages').append($('<li>').text(data.event + JSON.stringify(data.data)))
            })

            // socket.on('profile', function (data) {
            //     $('#messages').append($('<li>').text(data.event + JSON.stringify(data.data)))
            // })


            var yourTrun = false
            var color = 'black'

            const diceClick = () => {
                setTimeout(function () {
                    if (yourTrun) {
                        // $('#rollDice').click()
                    }
                }, 2000)
            }

            socket.on('gameEvent', function (data) {
                if (data.event === 'changeTurn') {
                    yourTrun = false
                    color = 'black'
                    $('#rollDice').hide()
                    $('#move').hide()
                    $('#messages').append($('<li>').text(data.event + ' ' + JSON.stringify(data.data)))
                }
                else if (data.event === 'yourTurn') {
                    yourTrun = true
                    color = 'blue'
                    $('#rollDice').show()
                    // diceClick()
                    $('#messages').append($('<li>').text(data.event).css('color', color))
                }
                else if (data.event === 'marblesCanMove' && yourTrun) {
                    console.log('marblesCanMove')
                    console.log('yourTrun')
                    $('#rollDice').hide()
                    $('#move').show()
                    $('#messages').append($('<li>').text(data.event + ' ' + data.data).css('color', color))
                    const marblesArray = data.data
                    // var selectedNumber = Math.floor(Math.random() * marblesArray.length) + 1;

                    // console.log("my array: ", marblesArray);
                    // var rand = marblesArray[Math.floor(Math.random() * marblesArray.length)];
                    // console.log("picked number: ", rand);
                    // setTimeout(function () {
                    //     console.log("move!");
                    //     socket.emit('event', JSON.stringify({
                    //         act: 'move',
                    //         data: {
                    //             marbleNumber: rand
                    //         }
                    //     }))
                    // }, 2000)

                    marblesArray.forEach((item, index) => {

                        $('#move').append('<option value="' + item + '">' + item + '</option>')

                    })
                }
                else if (data.event === 'yourPlayerNumber') {
                    $('#messages').append($('<li>').text(data.event + ' ' + JSON.stringify(data.data)).css('color', color))
                    $('#playerNumber').text(data.data)
                }
                else
                    $('#messages').append($('<li>').text(data.event + ' ' + JSON.stringify(data.data)).css('color', color))


                if (data.event === 'canRollDiceAgain' && yourTrun) {
                    $('#rollDice').show()
                    // diceClick()
                }
                if (data.event === 'marblesPosition' && yourTrun) {
                    console.log('--------' + yourTrun + '----------')
                    $('#rollDice').show()
                    // diceClick()
                }
            })
        })
    })
</script>
</body>
</html>
