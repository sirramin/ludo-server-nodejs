<!doctype html>
<html>
<head>
    <title>mench client</title>
</head>
<body>
<h1><span>you are player: </span><span id="playerNumber"></span></h1>
<ul id="messages"></ul>
<button id="clearToken">clearToken</button>
<button id="connect">connect</button>
<button id="joinRoom">joinRoom</button>
<button id="rollDice">rollDice</button>
<select id="move">
    <option value="">--</option>
</select>
<button id="leftRoom">leftRoom</button>
<button id="profile">profile</button>
<button id="followings">followings</button>
<button id="binary">binary</button>
<br>
<ul id="following-list"></ul>
<button style="display: none" id="invite">invite</button>
<!--<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script src="./flatBuffers/flatbuffers.js"></script>
<script src="components/user/flat/schemas/test_generated.js"></script>

<script>
  $(function () {
    const target = 'http://localhost:3001'
    let {token} = localStorage
    $('#messages').append($('<li>').text(JSON.stringify('token: ' + token)))
    $('#connect').click(async () => {
      if (!token) {
        const {token: singInToken} = await $.ajax({
          url: target + "/user/signInAsGuest",
          type: 'post',
          dataType: 'json',
        })
        localStorage.setItem("token", singInToken)
        token = singInToken
      }
      const socket = io(target, {transports: ['websocket'], query: {token}})
      $('#joinRoom').click(() => {
        socket.emit('joinRoom', 1)
      })

      $('#invite').click(() => {
        let usernamesArray = []
        $('.invite').each(function () {
          console.log($(this))
          const username = $(this).children('span').text()
          const checkbox = $(this).children('input')
          if ($(checkbox).is(':checked'))
            usernamesArray.push(username)
        })
        socket.emit('invite', usernamesArray)
      })

      $('#leftRoom').click(() => {
        socket.emit('leftRoom', 1)
      })

      $('#profile').click(() => {
        socket.emit('event', JSON.stringify({
          act: 'profile'
        }))
      })

      $('#rollDice').on('click', () => {
        $('#move').html('<option value="">--</option>')
        socket.emit('event', JSON.stringify({
          act: 'rollDice',
          data: {}
        }))
      })

      $('select').on('change', function () {
        if (this.value)
          socket.emit('event', JSON.stringify({
            act: 'move',
            data: {
              marbleNumber: this.value
            }
          }))
      })

      socket.on('message', function (msg) {
        $('#messages').append($('<li>').text(JSON.stringify(msg)))
      })

      socket.on('string', function (data) {
        $('#messages').append($('<li>').text(data))
      })

      socket.on('json', function (data) {
        $('#messages').append($('<li>').text(JSON.stringify(data)))
      })

      // socket.on('profile', function (data) {
      //     $('#messages').append($('<li>').text(data + JSON.stringify(data.data)))
      // })

      socket.on('friendly', function (data) {
        if (data === 'friendlyMatchRequest')
          if (confirm('you are invited by ' + data.data.inviter)) {
            socket.emit('joinFriendly', 1)
          }
      })

      var yourTrun = false
      var color = 'black'

      const diceClick = () => {
        setTimeout(function () {
          if (yourTrun) {
            // $('#rollDice').click()
          }
        }, 2000)
      }

      socket.on('json', function (data) {
        if (data.hasOwnProperty('changeTurn')) {
          yourTrun = false
          color = 'black'
          $('#rollDice').hide()
          $('#move').hide()
          $('#messages').append($('<li>').text(data + ' ' + JSON.stringify(data.data)))
        } else if (data === 'yourTurn') {
          yourTrun = true
          color = 'blue'
          $('#rollDice').show()
          // diceClick()
          $('#messages').append($('<li>').text(data).css('color', color))
        } else if (data === 'marblesCanMove' && yourTrun) {
          console.log('marblesCanMove')
          console.log('yourTrun')
          $('#rollDice').hide()
          $('#move').show()
          $('#messages').append($('<li>').text(data + ' ' + data.data).css('color', color))
          const marblesArray = data.data
          // var selectedNumber = Math.floor(Math.random() * marblesArray.length) + 1;

          // console.log("my array: ", marblesArray);
          // var rand = marblesArray[Math.floor(Math.random() * marblesArray.length)];
          // console.log("picked number: ", rand);
          // setTimeout(function () {
          //     console.log("move!");
          //     socket.emit('event', JSON.stringify({
          //         act: 'move',
          //         data: {
          //             marbleNumber: rand
          //         }
          //     }))
          // }, 2000)

          marblesArray.forEach((item, index) => {

            $('#move').append('<option value="' + item + '">' + item + '</option>')

          })
        } else if (data.hasOwnProperty('yourPlayerNumber')) {
          // $('#messages').append($('<li>').text(data + ' ' + JSON.stringify(data.data)).css('color', color))
          $('#playerNumber').text(data.yourPlayerNumber)
        } else {
          // $('#messages').append($('<li>').text(data + ' ' + JSON.stringify(data.data)).css('color', color))
        }


        if (data === 'canRollDiceAgain' && yourTrun) {
          $('#rollDice').show()
          // diceClick()
        }
        if (data === 'marblesPosition' && yourTrun) {
          console.log('--------' + yourTrun + '----------')
          $('#rollDice').show()
          // diceClick()
        }
      })
    })

    $('#followings').click(async () => {
      const token = localStorage.token
      const followings = await $.ajax({
        url: target + "/friendship/followings",
        type: 'GET',
        headers: {
          token: token
        },
        dataType: 'json'
      })
      $.each(followings.data, (index, value) => {
        const invite = value.online ? '<input type="checkbox" >' : ''
        const li = '<li class="invite">' +
          '<span>' + value.user.username + '</span>'
          + ' - ' +
          value.online
          + invite
          + '</li>'
        $('#following-list').append(li)
      })
      $('#invite').show()
    })
    $('#clearToken').click(() => {
      localStorage.clear()
    })

    $('#binary').click(async() => {
      const byets = await $.ajax({
        url: target + "/user/testFlatBuffer",
        type: 'post',
        data: {
          market: 'cafeBazaar'
        },
      })
      const buf = new flatbuffers.ByteBuffer(byets);
      const ReposList = window.ReposList.getRootAsReposList(buf);
      console.log(ReposList.name())
    })
  })
</script>
</body>
</html>
