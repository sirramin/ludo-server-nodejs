<!doctype html>
<html>
<head>
    <title>Arta platfrom socket client</title>
</head>
<body>
<h1><span>you are player: </span><span id="playerNumber"></span></h1>
<ul id="messages"></ul>
<button id="connect">connect</button>
<button id="joinRoom">joinRoom</button>
<select id="move" multiple>
    <option value="0">purple</option>
    <option value="1">blue</option>
    <option value="2">green</option>
    <option value="3">red</option>
    <option value="4">yellow</option>
    <option value="5">silver</option>
</select>
<button id="arrange">arrange</button>
<button id="leftRoom">leftRoom</button>
<!--<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
    // const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYlVybCI6Im1lbmNobWFuIiwidXNlcklkIjoiNWI0MWZkZGY0YTBjYzg2YjQzMDMwODExIiwibmFtZSI6InVzZXI1ODYxNSIsIm1hcmtldCI6Im1jaSIsInVzZXJuYW1lIjoic2lycmFtaW41IiwiaWF0IjoxNTMxMDUxNDg3LCJleHAiOjE1MzE5MTU0ODd9.j9BamCitP6RiOCjJ-5ppvI-Kpqq4EMHRnAlBEFfrzV0"
    $(function () {
        // const target = 'http://platform.artagamestudio.com'
        const target = 'http://localhost:3000'
        let token
        $('#connect').click(async () => {
            if (!localStorage.token) {
                const res = await $.ajax({
                    url: target + "/user/signInAsGuest",
                    type: 'post',
                    data: {
                        market: 'cafeBazaar'
                    },
                    headers: {
                        gameid: '5b39d183afff3d2cf7833f6f', //master game
                    },
                    dataType: 'json',
                })
                localStorage.setItem("token", res.data.token)
                token = res.data.token
            }
            else {
                token = localStorage.token
                // const res = await $.ajax({
                //     url: target + "/logics/master/getUserGameData",
                //     type: 'get',
                //     headers: {
                //         token: localStorage.token
                //     },
                //     dataType: 'json',
                // })

                // if (!localStorage.userId)
                //     localStorage.setItem("userId", res.data.userId)
                // localStorage.setItem("UserGameData", JSON.stringify(res.data))
            }
            const socket = io(target, {transports: ['websocket'], query: {token: token}})
            $('#joinRoom').click(() => {
                socket.emit('joinRoom', 1)
            })

            $('#leftRoom').click(() => {
                socket.emit('leftRoom', 1)
            })

            $('#arrange').on('click', function () {
                if ($('select').value)
                    socket.emit('event', JSON.stringify({
                        act: 'arrange',
                        data: {
                            combination: $('select').value
                        }
                    }))
            })

            socket.on('message', function (msg) {
                $('#messages').append($('<li>').text(JSON.stringify(msg)))
            })

            socket.on('matchEvent', function (data) {
                $('#messages').append($('<li>').text(data.event + JSON.stringify(data.data)))
            })

            socket.on('gameEvent', function (data) {
                if (data.event === 'yourPlayerNumber') {
                    $('#messages').append($('<li>').text(data.event + ' ' + JSON.stringify(data.data)))
                    $('#playerNumber').text(data.data)
                }
                else
                    $('#messages').append($('<li>').text(data.event + ' ' + JSON.stringify(data.data)))

            })
        })
    })
</script>
</body>
</html>
